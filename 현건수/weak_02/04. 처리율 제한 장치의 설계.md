## 처리율 제한 장치의 설계

> 처리율 제한장치(rate limiter)는 `클라이언트 또는 서비스가 보내는 트래픽 처리율을 제어`하기 위한 장치이다. HTTP를 예로 들면 이 장치는 특정 기간 내에 전송되는 클라이언트 수를 제한한다. API 호출 횟수가 정해진 임계치(threshold)를 넘어가면 추가로 도달한 모든 호출은 처리가 중단된다.
> 

### 사례

- 사용자는 초당 2회 이상 새 글을 올릴 수 없다
- 같은 IP 주소로는 하루에 10개 이상의 계정을 생성할 수 없다
- 같은 디바이스로는 주당 5회 이상 리워드를 요청할 수 없다

### 장점

- DoS 공격 방지
- 비용 절감
- 서버 과부하 막음

## 1단계. 문제 이해 및 설계 범위 확정

> 처리율 제한 장치를 구현하는 데에 `여러 알고리즘`을 사용할 수 있다. 면접관과 소통하면서 어떤 제한 장치를 구현해야 하는지 분명히 할 수 있다
> 

### 질문

- 클라이언트 vs 서버 제한?
    - 서버 API 제한
- API 호출 제한? or IP 제한? or 사용자 ID 제한?
    - 다양한 형태의 제어 규칙을 정의할 수 있는 유연한 시스템이여야한다.
- 시스템 규모?
    - 설계할 시스템은 대규모 요청을 처리할 수 있어야한다
- 분산 환경 동작?
    - 그렇습니다.
- 처리율 제한 장치는 독립된 서비스? 어플리케이션 코드에 포함?
    - 본인이 정하시면 됩니다.
- 사용자의 요청이 처리율 제한 장치에 걸릴 경우 사용자에게 사실을 알려야하는지?
    - 그렇습니다
    

### 요구사항

- 처리율을 초과하는 요청은 정확하게 제한한다
- 낮은 응답시간: HTTP 응답시간에 나쁜 영향을 주어 곤란하다
- 가능한 적은 메모리를 써야한다
- 분산형 처리율 제한 : 하나의 처리율 제한 장치를 여러 서버나 프로세스에 공유해야한다
- 예외처리 : 요청이 제한 됐을 때 사실을 사용자에게 알려야한다
- 높은 결함 감내성(falut toerance) : 제한 장치에 장애가 생기더라도 전체 시스템에 영향을 주어서는 안된다.

## 2단계. 개략적 설계안 제시 및 동의 구하기

<p align="center">
  <img src="https://user-images.githubusercontent.com/76584547/224060712-365c8280-0992-4541-a99c-0029fd39d03a.png">
</p>

- 서버측에 처리율 제한장치를 두지 않고 `미들웨어`를 만들어 해당 미들웨어로 하여금 API 서버로 가는 요청을 통제할 수 있다.
- 2개로 제한된 요청에서 3개를 보낼 경우 `429: Too many requests` HTTP 상태코드를 응답 받는다

### API 게이트웨이

> MSA인 경우, 처리율 제한 장치는 보통 API 게이트 웨이를 사용
> 
- 특징
    - 처리율 제한
    - SSL 종단
    - 사용자 인증
    - IP 허용 목록 관리

## 처리율 제한 알고리즘

처리율 제한 알고리즘 5가지

- 토큰 버킷
- 누출 버킷
- 고정 윈도 카운터
- 이동 윈도 로그
- 이동 윈도 카운터
