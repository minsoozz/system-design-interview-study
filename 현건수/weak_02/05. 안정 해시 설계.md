## 안정 해시 설계

> 스케일아웃을 달성하기 위해 요청 또는 데이터를 서버에 균등하게 나누는 것이 중요하다
> 

## 전통 해시 테이블 refresh의 문제

> N개의 캐시 서버가 있다고 하자. 이 서버들에 부하를 균등하게 나누는 보편적인 방법은 아래의 해시 함수를 사용하는 것이다
> 

```bash
severIndex = hash(key) % N (N은 서버의 개수이다)
```

<p align="center">
  <img src="https://user-images.githubusercontent.com/76584547/224109150-bf1818b4-fad6-41ea-a7a8-2d35eb7e5753.png">
</p>

### 특징

- 서버 풀의 크기가 고정되어 있을 때, 그리고 데이터 분포가 균등할 때 잘 동작한다
- 하지만 서버가 추가되거나 기존 서버가 삭제되면 문제가 생긴다

<p align="center">
  <img src="https://user-images.githubusercontent.com/76584547/224109200-0119f459-4fe9-47a4-b250-d315b4a2d285.png">
</p>


### 문제

- 장애가 발생한 1번 서버에 보관되어 있는 키 뿐만 아닌 대부분의 키가 재 분배되었다
- 1번 서버가 죽으면 대부분 캐시 클라이언트가 데이터가 없는 엉뚱한 서버에 접속
- 대규모 캐시 미스가 발생

## 안정 해시

> 위키피디아에 따르면 안정해시는 `해시 테이블 크기가 조정될 때 평균적으로 오직 k/n개의 키만 재배치하는 해시 기술`
> 

### 해시 공간과 해시 링

<p align="center">
  <img src="https://user-images.githubusercontent.com/76584547/224109257-504629d0-249f-4f79-9ba9-3e3d707a3292.png">
</p>


### 특징

- SHA-1의 해시공간을 사용한다고 가정하면 범위는 0부터 2^160 -1
- 따라서 x0는 0, xn 은 2^160-1의 사이값을 갖게된다
- 양쪽 값을 구부려서 해시링을 만든다

### 해시 서버

<p align="center">
  <img src="https://user-images.githubusercontent.com/76584547/224109292-b4fd9be5-f16d-46d1-a9bb-69becc4d9a59.png">
</p>


### 특징

- 해당 해시함수 f를 사용하면 서버 IP나 이름을 위 링의 어떤 위치에 대응 시킬 수 있다
- 4개의 서버를 해시링 위에 배치

### 해시 키

<p align="center">
  <img src="https://user-images.githubusercontent.com/76584547/224109334-5ff6e83b-8790-4f66-a73c-fbda84785e39.png">
</p>


### 특징

- key0, key1, key2, key3 또한 해시링 위에 배치할 수 있다
- key0은 s0, key1은 s1에 저장되어있으며 해당 키의 위치로부터 `시계방향으로 링을 탐색해 만나는 첫 서버에 키가 저장`된다
- 서버를 추가하더라도 키 가운데 일부만 재배치하면 된다.
- 서버를 제거해도 key만 다른 서버로 재배치되기 때문에 나머지 키에 영향이 없다

### 기본 구현법의 두가지 문제

- 링 위에 4개의 서버가 있다고 가정했을 경우, 한 서버가 죽으면 `파티션 크기를 균등하게 유지하는 것이 불가능`
- 그렇게 되면 한 서버에 많은 `키들도 불균등하게 저장`될 수 있다

### 가상노드

- 링 위에 s0을 배치하기 위해 s0하나만 쓰는 대신, s0_0, s0_1, s0_2의 세 개 가상 노드를 사용
- 따라서 각 서버는 하나가 아닌 여러 개 파티션을 관리해야한다.
- k0은 시계방향으로 만나는 최초의 서버 s1_1이에 저장된다.
- 가상 노드의 개수를 늘리면 `키의 분포는 점점 균등해진다` 그러나 `가상 노드 데이터를 저장할 공간은 더 필요`해서 tradeoff가 필요하다


<p align="center">
  <img src="https://user-images.githubusercontent.com/76584547/224109377-0ee34b4e-d70c-45c5-9bd9-d62874962aba.png">
</p>


### 안정 해시의 장점

- 서버가 추가되거나 삭제될 때 재배치되는 키의 수가 최소화
- 데이터가 보다 `균등`하게 분포되므로 스케일 아웃이 쉽다
- `핫스팟키 문제를 줄인다` 한쪽 서버에 몰리는 것을 방지하여 데이터를 좀 더 균등하게 분배할 수 있다

### 예시

- AWS DDB 파티셔닝
- 아파치 카산드라 클러스터에서의 데이터 파티셔닝
- 디스코드 채팅 어플리케이션
- 아카마이 CDN
- 매그레프 네트워크 부하분산기
